<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="blogs.css" />
  <title>Backtesting a Trading Strategy in Python – Part 2</title>
  <style>
    code {
      background: black;
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      display: inline-block;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="container">
        <a href="index.html" class="navbar-brand">harshmanchadha.in</a>
        <div class="navbar-nav">
          <a href="index.html">home</a>
          <a href="index.html#blog">blogs</a>
          <a href="index.html#about">about</a>
          <a href="index.html#contact">contact</a>
        </div>
      </div>
    </nav>
  </header>
  <hr>

  <main>
    <section class="blog-banner">
      <h1 class="blog-banner-title">Backtesting a Trading Strategy in Python – Part 2</h1>
    </section>

    <section class="blog" id="blog">
      <div class="container">
        <article class="blog-text">
          <div class="blog-title">
            <span>18 April, 2025</span>
            <h2>Calculating Returns, Adding Indicators, and Optimizing Strategy</h2>
            <img src="images/blog10.jpg" alt="Backtesting Advanced">
          </div>

          <p>In the <a href="blog9.html">previous part</a>, we got our hands dirty with basic backtesting using Python and Backtrader. If you’ve reached here, then great—you’ve already taken the first real step into quantitative strategy development.</p>

          <p>This one’s going to be a bit more intense. We’ll calculate actual returns and drawdowns, introduce some technical indicators like RSI and MACD, and finally tweak our strategy to test what works better.</p>

          <h3>Step 1: Adding RSI & MACD</h3>
          <p>Let’s enhance our SMA crossover with two common indicators: RSI (Relative Strength Index) and MACD (Moving Average Convergence Divergence).</p>
          <code>
class SMACrossoverEnhanced(bt.Strategy):
    def __init__(self):
        self.sma50 = bt.indicators.SMA(self.data.close, period=50)
        self.sma200 = bt.indicators.SMA(self.data.close, period=200)
        self.rsi = bt.indicators.RSI(self.data.close, period=14)
        self.macd = bt.indicators.MACD(self.data.close)

    def next(self):
        if (self.sma50[0] > self.sma200[0] and 
            self.rsi[0] > 50 and 
            self.macd.macd[0] > self.macd.signal[0] and 
            not self.position):
            self.buy()

        elif (self.sma50[0] < self.sma200[0] or
              self.rsi[0] < 50 or 
              self.macd.macd[0] < self.macd.signal[0]) and self.position:
            self.sell()
          </code>

          <p>Now this strategy only enters long positions when all three conditions align.</p>

          <h3>Step 2: Calculating Returns & Drawdowns</h3>
          <p>After running the strategy, you can extract portfolio value over time like this:</p>
          <code>
class PerformanceAnalyzer(bt.Analyzer):
    def __init__(self):
        self.daily_value = []

    def next(self):
        self.daily_value.append(self.strategy.broker.getvalue())

cerebro = bt.Cerebro()
cerebro.addstrategy(SMACrossoverEnhanced)
cerebro.addanalyzer(PerformanceAnalyzer, _name='perf')
results = cerebro.run()
perf = results[0].analyzers.perf.daily_value
          </code>

          <p>Then calculate returns:</p>
          <code>
returns = pd.Series(perf).pct_change().dropna()
cumulative = (1 + returns).cumprod()
drawdown = cumulative / cumulative.cummax() - 1
max_dd = drawdown.min()
print(f'Maximum Drawdown: {max_dd:.2%}')
          </code>

          <h3>Step 3: Strategy Optimization</h3>
          <p>Let’s try different combinations of moving average periods to see which performs best.</p>
          <code>
class SMADynamic(bt.Strategy):
    params = (('fast', 20), ('slow', 100))

    def __init__(self):
        sma_fast = bt.indicators.SMA(self.data.close, period=self.params.fast)
        sma_slow = bt.indicators.SMA(self.data.close, period=self.params.slow)
        self.crossover = bt.ind.CrossOver(sma_fast, sma_slow)

    def next(self):
        if self.crossover > 0 and not self.position:
            self.buy()
        elif self.crossover < 0 and self.position:
            self.sell()

cerebro = bt.Cerebro()
cerebro.optstrategy(SMADynamic, fast=range(10, 60, 10), slow=range(80, 220, 20))
cerebro.adddata(bt.feeds.PandasData(dataname=data))
results = cerebro.run()
          </code>

          <p>Now you can extract the results and rank them by final portfolio value.</p>

          <h3>Visualizing Optimization Results</h3>
          <p>Using matplotlib for heatmap (optional):</p>
          <code>
import seaborn as sns
import numpy as np

# Suppose you collect results in a DataFrame
sns.heatmap(result_df.pivot("fast", "slow", "final_value"), annot=True, fmt=".0f")
plt.title("Optimization Results")
plt.show()
          </code>
          <img src="images/b10-pic1.png" alt="Optimization Heatmap">

          <h3>Wrapping Up</h3>
          <p>If you’ve followed through both blogs, you now know how to:</p>
          <ul>
            <li>Backtest basic and advanced strategies using Python</li>
            <li>Use indicators like SMA, RSI, MACD</li>
            <li>Analyze performance with returns and drawdowns</li>
            <li>Run optimization sweeps to tune parameters</li>
          </ul>

          <p>This forms the core of what a quantitative trader does before going live. And trust me, the more you automate and structure your approach, the better you'll get at decision-making.</p>

          <p>I might do a final blog in this series where I show how to create a screener or dashboard to run multiple strategies together. Let’s see how that pans out!</p>

          <div class="back-links">
            <a href="index.html#blog">← Back to Blogs</a>
          </div>
        </article>
      </div>
    </section>
  </main>
  <hr>

  <footer>
    <section class="contact" id="contact">
      <p>get in touch!</p>
      <br>
      <div class="social-links">
        <a href="mailto:chadhaharshman@gmail.com" target="_blank"><i class="fas fa-envelope"></i></a>
        <a href="https://www.instagram.com/harshman.chadha" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://www.linkedin.com/in/harshman-chadha-047825250/" target="_blank"><i class="fab fa-linkedin"></i></a>
      </div>
      <span>harshman.chadha</span>
    </section>
  </footer>
</body>
</html>
